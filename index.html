<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Webcam ASCII Mobile</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #111;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #0f0;
            font-family: 'Courier New', Courier, monospace;
            height: 100vh; /* Fix para móviles */
        }
        
        /* Capa de UI */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: none; /* Dejar pasar clicks salvo en botones */
        }

        /* Pantalla de Inicio (Overlay) */
        #start-screen {
            background: rgba(0,0,0,0.9);
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 50;
            pointer-events: auto; /* Habilitar clicks aquí */
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        button {
            background: transparent;
            border: 2px solid #0f0;
            color: #0f0;
            padding: 15px 30px;
            font-family: inherit;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            text-transform: uppercase;
            transition: all 0.3s;
        }

        button:hover { background: #0f0; color: #000; }
        button:active { transform: scale(0.95); }

        /* Información de estado pequeña */
        #status-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        #videoSource { display: none; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="margin-bottom: 10px;">ASCII MIRROR</h1>
        <p style="color: #ccc; font-size: 0.9rem;">Requiere acceso a cámara</p>
        <button id="btn-start">INICIAR EXPERIENCIA</button>
        <p id="error-msg" style="color: red; margin-top: 15px; font-size: 0.8rem;"></p>
    </div>

    <div id="ui-layer" style="display:none;">
        <div id="status-bar">Cargando IA...</div>
    </div>
    
    <video id="videoSource" playsinline webkit-playsinline muted></video>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.9/+esm"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

        // Variables Globales
        let renderer, scene, camera;
        let video, videoTexture, fontTexture;
        let customMaterial;
        let handLandmarker;
        let lastVideoTime = -1;
        let animationId;
        
        let currentEffectValue = 0;
        let targetEffectValue = 0;
        let isHandDetected = false;

        // Elementos del DOM
        const startScreen = document.getElementById('start-screen');
        const uiLayer = document.getElementById('ui-layer');
        const btnStart = document.getElementById('btn-start');
        const statusBar = document.getElementById('status-bar');
        const errorMsg = document.getElementById('error-msg');
        const videoElement = document.getElementById('videoSource');

        // --- Event Listener para el botón ---
        btnStart.addEventListener('click', async () => {
            btnStart.textContent = "CARGANDO...";
            btnStart.disabled = true;
            
            try {
                await init();
                // Si todo va bien, ocultamos la pantalla de inicio
                startScreen.style.display = 'none';
                uiLayer.style.display = 'flex';
            } catch (e) {
                console.error(e);
                btnStart.textContent = "REINTENTAR";
                btnStart.disabled = false;
                errorMsg.innerText = `Error: ${e.name} - ${e.message}`;
            }
        });

        // 1. Textura ASCII
        function createAsciiTexture() {
            const canvas = document.createElement('canvas');
            const chars = " .:-=+*#%@"; 
            const charCount = chars.length;
            const fontSize = 64;
            canvas.width = fontSize * charCount; 
            canvas.height = fontSize;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = "#000000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.font = `bold ${fontSize}px monospace`;
            ctx.fillStyle = "#ffffff";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            for (let i = 0; i < charCount; i++) {
                ctx.fillText(chars[i], i * fontSize + (fontSize / 2), fontSize / 2);
            }
            const texture = new THREE.CanvasTexture(canvas);
            texture.minFilter = THREE.NearestFilter;
            texture.magFilter = THREE.NearestFilter;
            return { texture, charCount };
        }

        // 2. Shaders
        const vertexShader = `
            varying vec2 vUv;
            void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 ); }
        `;

        const fragmentShader = `
            uniform sampler2D tDiffuse;
            uniform sampler2D tFont;
            uniform float uInteraction;
